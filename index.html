<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DOMINO MASTER Online</title>
    <link href="https://fonts.googleapis.com/css2?family=Righteous&family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    
    <style>
        :root { 
            --bg-color: #0f172a; 
            --glass-bg: rgba(30, 41, 59, 0.8);
            --domino-white: #f1f2f6;
            --domino-black: #1e272e;
            --accent-color: #3b82f6; 
            --text-color: #e2e8f0;
            --danger: #ef4444;
        }

        body { 
            font-family: 'Cairo', sans-serif; 
            background-color: var(--bg-color); 
            color: var(--text-color);
            margin: 0; 
            padding: 0; 
            overflow: hidden; /* Ù„Ù…Ù†Ø¹ Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø§Ù„Ø¹Ø§Ù… */
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† */
        h1.game-title {
            font-family: 'Righteous', cursive;
            font-size: 3rem;
            color: var(--accent-color);
            text-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
            margin: 10px 0;
            text-align: center;
            letter-spacing: 2px;
        }

        .container {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            position: relative;
        }

        /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙˆØ§Ù„Ø­Ù‚ÙˆÙ„ */
        input {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            padding: 12px;
            color: white;
            border-radius: 8px;
            margin: 5px;
            font-size: 16px;
            text-align: center;
            outline: none;
        }
        button {
            background: var(--accent-color);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.3s;
            font-family: 'Cairo', sans-serif;
            margin: 5px;
        }
        button:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(59, 130, 246, 0.4); }
        .hidden { display: none !important; }

        /* Ø§Ù„Ø´Ø§Ø´Ø§Øª */
        .screen {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            max-width: 500px;
            width: 90%;
        }

        /* --- ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¯ÙˆÙ…ÙŠÙ†Ùˆ Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ --- */
        .domino {
            background-color: var(--domino-white);
            border-radius: 4px;
            box-shadow: 2px 2px 0px #999, inset 0 0 5px rgba(0,0,0,0.1);
            display: flex;
            cursor: pointer;
            transition: transform 0.2s;
            position: relative;
            overflow: hidden;
        }
        .domino:hover { transform: scale(1.05); }
        
        /* Ø§Ù„Ø®Ø· Ø§Ù„ÙØ§ØµÙ„ */
        .line { background-color: #ccc; }

        /* Ø§Ù„Ù†Ù‚Ø§Ø· (Pips) */
        .pip-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            padding: 4px;
            box-sizing: border-box;
        }
        .pip { background-color: var(--domino-black); border-radius: 50%; width: 100%; height: 100%; box-shadow: inset 0 1px 2px rgba(0,0,0,0.5); }
        /* Ø£Ù…Ø§ÙƒÙ† Ø§Ù„Ù†Ù‚Ø§Ø· Ø¯Ø§Ø®Ù„ Ø§Ù„Ø´Ø¨ÙƒØ© 3x3 */
        .p1 { grid-area: 2 / 2; } /* Ø§Ù„Ù…Ù†ØªØµÙ */
        .p2-1 { grid-area: 1 / 3; } .p2-2 { grid-area: 3 / 1; }
        .p3-1 { grid-area: 1 / 3; } .p3-2 { grid-area: 2 / 2; } .p3-3 { grid-area: 3 / 1; }
        .p4-1 { grid-area: 1 / 1; } .p4-2 { grid-area: 1 / 3; } .p4-3 { grid-area: 3 / 1; } .p4-4 { grid-area: 3 / 3; }
        .p5-1 { grid-area: 1 / 1; } .p5-2 { grid-area: 1 / 3; } .p5-3 { grid-area: 2 / 2; } .p5-4 { grid-area: 3 / 1; } .p5-5 { grid-area: 3 / 3; }
        .p6-1 { grid-area: 1 / 1; } .p6-2 { grid-area: 1 / 3; } .p6-3 { grid-area: 2 / 1; } .p6-4 { grid-area: 2 / 3; } .p6-5 { grid-area: 3 / 1; } .p6-6 { grid-area: 3 / 3; }

        /* --- Ø£Ø­Ø¬Ø§Ù… Ø§Ù„Ø¯ÙˆÙ…ÙŠÙ†Ùˆ --- */
        
        /* 1. Ø§Ù„Ø¯ÙˆÙ…ÙŠÙ†Ùˆ ÙÙŠ Ø§Ù„ÙŠØ¯ (Ø¯Ø§Ø¦Ù…Ø§Ù‹ ÙˆØ§Ù‚Ù) */
        .hand-tile {
            width: 40px; height: 80px; flex-direction: column; margin: 0 5px;
        }
        .hand-tile .line { height: 2px; width: 90%; margin: 2px auto; }
        .hand-tile .pip-container { width: 40px; height: 38px; }
        .hand-tile .pip { width: 6px; height: 6px; margin: auto; }

        /* 2. Ø§Ù„Ø¯ÙˆÙ…ÙŠÙ†Ùˆ Ø¹Ù„Ù‰ Ø§Ù„Ø·Ø§ÙˆÙ„Ø© (Horizontal by default) */
        .board-tile {
            width: 80px; height: 40px; flex-direction: row; margin: 0 2px;
            box-shadow: 1px 3px 5px rgba(0,0,0,0.5);
        }
        .board-tile .line { width: 2px; height: 90%; margin: auto 2px; }
        .board-tile .pip-container { width: 38px; height: 40px; }
        .board-tile .pip { width: 6px; height: 6px; margin: auto; }

        /* 3. Ø§Ù„Ø¯ÙˆÙ…ÙŠÙ†Ùˆ Ø§Ù„Ø¯Ø¨Ù„ (Double) Ø¹Ù„Ù‰ Ø§Ù„Ø·Ø§ÙˆÙ„Ø© (Vertical) */
        .board-tile.double {
            width: 40px; height: 80px; flex-direction: column; margin: 0 5px; transform: translateY(-10px); /* Ø±ÙØ¹ Ø¨Ø³ÙŠØ· */
        }
        .board-tile.double .line { height: 2px; width: 90%; margin: 2px auto; }
        .board-tile.double .pip-container { width: 40px; height: 38px; }

        /* --- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù„Ø¹Ø¨ --- */
        #game-interface { width: 100%; height: 100%; display: flex; flex-direction: column; }
        
        /* Ø´Ø±ÙŠØ· Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù„ÙˆÙŠ */
        #top-bar {
            padding: 10px 20px;
            background: rgba(0,0,0,0.3);
            display: flex; justify-content: space-between; align-items: center;
        }
        
        /* Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† */
        #opponents-area {
            display: flex; justify-content: center; gap: 20px; padding: 10px;
        }
        .player-card {
            background: rgba(255,255,255,0.1); padding: 10px 20px; border-radius: 10px;
            text-align: center; border: 1px solid transparent; position: relative;
        }
        .player-card.active-turn { border-color: var(--accent-color); background: rgba(59, 130, 246, 0.2); }
        .card-count { font-weight: bold; font-size: 1.2rem; color: #fbbf24; }

        /* Ø·Ø§ÙˆÙ„Ø© Ø§Ù„Ù„Ø¹Ø¨ */
        #board-container {
            flex: 1;
            background-color: #1a2639; /* Ù„ÙˆÙ† Ø§Ù„Ø·Ø§ÙˆÙ„Ø© Ù…Ø®ØªÙ„Ù Ù‚Ù„ÙŠÙ„Ø§Ù‹ */
            margin: 10px;
            border-radius: 20px;
            border: 4px solid #2d3e56;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: auto;
            position: relative;
            box-shadow: inset 0 0 50px rgba(0,0,0,0.5);
        }
        #game-board {
            display: flex;
            align-items: center;
            padding: 50px;
        }

        /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ÙŠØ¯ */
        #my-hand-area {
            background: rgba(0,0,0,0.4);
            padding: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100px;
            overflow-x: auto;
        }

        /* --- Ù†Ø¸Ø§Ù… Ø§Ù„Ø´Ø§Øª --- */
        #chat-fab {
            position: fixed;
            bottom: 20px; left: 20px;
            width: 60px; height: 60px;
            background: var(--accent-color);
            border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            z-index: 1000;
        }
        #chat-badge {
            position: absolute; top: 0; right: 0;
            background: var(--danger); color: white;
            width: 20px; height: 20px; border-radius: 50%;
            font-size: 12px; display: flex; justify-content: center; align-items: center;
            border: 2px solid var(--bg-color);
        }
        #chat-window {
            position: fixed;
            bottom: 90px; left: 20px;
            width: 300px; height: 400px;
            background: var(--glass-bg);
            backdrop-filter: blur(15px);
            border-radius: 15px;
            display: flex; flex-direction: column;
            border: 1px solid rgba(255,255,255,0.1);
            z-index: 999;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }
        #chat-messages {
            flex: 1; overflow-y: auto; padding: 10px;
            display: flex; flex-direction: column;
        }
        .chat-msg {
            background: rgba(255,255,255,0.1);
            padding: 8px; margin: 4px; border-radius: 8px;
            font-size: 14px; text-align: right;
        }
        .chat-msg.mine { background: rgba(59, 130, 246, 0.4); align-self: flex-end; }
        .chat-input-area {
            padding: 10px; border-top: 1px solid rgba(255,255,255,0.1);
            display: flex;
        }
        
        /* Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø´Ø§Øª SVG */
        .icon-chat { width: 30px; height: 30px; fill: white; }

    </style>
</head>
<body>

    <h1 class="game-title">DOMINO MASTER</h1>

    <div class="container">
        <div id="screen-login" class="screen">
            <h2>ğŸ‘¤ Ù‡ÙˆÙŠØ© Ø§Ù„Ù„Ø§Ø¹Ø¨</h2>
            <input type="text" id="username" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ Ù‡Ù†Ø§..." maxlength="15">
            <br>
            <button onclick="saveName()">Ø¯Ø®ÙˆÙ„</button>
        </div>

        <div id="screen-menu" class="screen hidden">
            <h2 id="welcome-text">Ù…Ø±Ø­Ø¨Ø§Ù‹</h2>
            <div style="margin: 20px 0;">
                <button onclick="createRoom()" style="background:#10b981; width:80%">Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ© Ø®Ø§ØµØ©</button>
            </div>
            <div style="display:flex; justify-content:center; align-items:center;">
                <input type="text" id="room-code-input" placeholder="ÙƒÙˆØ¯ Ø§Ù„ØºØ±ÙØ©" style="width: 120px;">
                <button onclick="joinRoom()">Ø§Ù†Ø¶Ù…Ø§Ù…</button>
            </div>
        </div>

        <div id="screen-lobby" class="screen hidden">
            <h2>ØºØ±ÙØ© Ø±Ù‚Ù…: <span id="lobby-code" style="color:#fbbf24"></span></h2>
            <p>ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†...</p>
            <ul id="lobby-list" style="list-style:none; padding:0; text-align:right;"></ul>
            <button id="start-game-btn" class="hidden" onclick="startGame()">âš¡ Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨</button>
            <button onclick="leaveRoom()" style="background:var(--danger)">Ø®Ø±ÙˆØ¬</button>
        </div>

        <div id="screen-game" class="hidden" style="width:100%; height:100%;">
            <div id="game-interface">
                <div id="top-bar">
                    <button onclick="leaveRoom()" style="background:var(--danger); padding:5px 15px; font-size:12px;">Ø§Ù†Ø³Ø­Ø§Ø¨</button>
                    <div id="turn-info" style="font-weight:bold; color:#fbbf24;">Ø§Ù„Ø¯ÙˆØ±: ---</div>
                    <div style="color:white;">Code: <span id="game-room-code"></span></div>
                </div>

                <div id="opponents-area"></div>

                <div id="board-container">
                    <div id="game-board"></div>
                </div>

                <div style="text-align:center; color:#ccc; font-size:12px;">Ø£ÙˆØ±Ø§Ù‚Ùƒ</div>
                <div id="my-hand-area"></div>
                
                <button id="draw-btn" class="hidden" style="position:absolute; bottom:130px; left:50%; transform:translateX(-50%); background:#e67e22; z-index:10;">Ø³Ø­Ø¨ ÙˆØ±Ù‚Ø©</button>
            </div>
        </div>
    </div>

    <div id="chat-fab" class="hidden" onclick="toggleChat()">
        <div id="chat-badge" class="hidden">0</div>
        <svg class="icon-chat" viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/></svg>
    </div>

    <div id="chat-window" class="hidden">
        <div style="padding:10px; background:rgba(0,0,0,0.2); border-radius:15px 15px 0 0; display:flex; justify-content:space-between;">
            <span>Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©</span>
            <span onclick="toggleChat()" style="cursor:pointer;">âœ–</span>
        </div>
        <div id="chat-messages"></div>
        <div class="chat-input-area">
            <input type="text" id="chat-input" placeholder="Ø§ÙƒØªØ¨..." style="flex:1; margin:0;">
            <button onclick="sendMsg()" style="padding:5px 15px; margin:0 5px;">â¤</button>
        </div>
    </div>

<script>
    // --- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase ---
    const firebaseConfig = {
        apiKey: "AIzaSyCp9_P3K__Sr76iKgaVG1iD4NluUqPtni4",
        authDomain: "heka-codenames.firebaseapp.com",
        projectId: "heka-codenames",
        storageBucket: "heka-codenames.firebasestorage.app",
        messagingSenderId: "901713932504",
        appId: "1:901713932504:web:b6710ddf537cd3c7c4e7ad"
    };
    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.database();

    // --- Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© ---
    let myName = "";
    let myId = "";
    let currentRoom = "";
    let isHost = false;
    let gameData = {};
    let chatOpen = false;
    let unreadCount = 0;

    // --- ØªØ´ØºÙŠÙ„ Ø¹Ù†Ø¯ Ø§Ù„Ø¨Ø¯Ø¡ ---
    window.onload = () => {
        const saved = localStorage.getItem('domino_pro_name');
        if(saved) {
            document.getElementById('username').value = saved;
            saveName();
        }
    };

    // --- ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ§Ù„ØªÙ†Ù‚Ù„ ---
    function showScreen(screenId) {
        document.querySelectorAll('.screen').forEach(el => el.classList.add('hidden'));
        document.getElementById('screen-game').classList.add('hidden');
        
        const el = document.getElementById(screenId);
        if(el) el.classList.remove('hidden');
    }

    function saveName() {
        const val = document.getElementById('username').value.trim();
        if(!val) return alert("Ø§ÙƒØªØ¨ Ø§Ø³Ù… ÙŠØ§ Ù†Ø¬Ù…");
        myName = val;
        localStorage.setItem('domino_pro_name', myName);
        document.getElementById('welcome-text').innerText = `Ø£Ù‡Ù„Ø§Ù‹ ÙŠØ§ ${myName}`;
        showScreen('screen-menu');
    }

    // --- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØºØ±Ù ---
    function createRoom() {
        const code = Math.floor(1000 + Math.random() * 9000).toString();
        myId = Date.now().toString();
        
        db.ref('rooms/' + code).set({
            status: 'waiting',
            host: myId,
            players: {
                [myId]: { name: myName, hand: [], count: 0 }
            }
        }).then(() => enterRoom(code, true));
    }

    function joinRoom() {
        const code = document.getElementById('room-code-input').value.trim();
        if(!code) return alert("ÙÙŠÙ† Ø§Ù„ÙƒÙˆØ¯ØŸ");
        myId = Date.now().toString();

        db.ref('rooms/' + code).once('value', snapshot => {
            if(!snapshot.exists()) return alert("Ø§Ù„ØºØ±ÙØ© Ø¯ÙŠ Ù…Ø´ Ù…ÙˆØ¬ÙˆØ¯Ø©");
            const data = snapshot.val();
            if(data.status !== 'waiting') return alert("Ø§Ù„Ù„Ø¹Ø¨Ø© Ø´ØºØ§Ù„Ø© Ø­Ø§Ù„ÙŠØ§Ù‹");
            if(Object.keys(data.players || {}).length >= 4) return alert("Ø§Ù„ØºØ±ÙØ© Ù…Ù„ÙŠØ§Ù†Ø©");

            db.ref(`rooms/${code}/players/${myId}`).set({
                name: myName, hand: [], count: 0
            }).then(() => enterRoom(code, false));
        });
    }

    function enterRoom(code, host) {
        currentRoom = code;
        isHost = host;
        
        document.getElementById('lobby-code').innerText = code;
        document.getElementById('game-room-code').innerText = code;
        
        showScreen('screen-lobby');
        if(isHost) document.getElementById('start-game-btn').classList.remove('hidden');

        // Ø¥Ø¸Ù‡Ø§Ø± Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø´Ø§Øª
        document.getElementById('chat-fab').classList.remove('hidden');
        
        // Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹
        listenToRoom();
    }

    function leaveRoom() {
        if(currentRoom && myId) {
            db.ref(`rooms/${currentRoom}/players/${myId}`).remove();
        }
        location.reload();
    }

    // --- Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª ---
    function listenToRoom() {
        db.ref(`rooms/${currentRoom}`).on('value', snapshot => {
            const data = snapshot.val();
            if(!data) return location.reload(); // Ø§Ù„ØºØ±ÙØ© Ø§ØªÙ…Ø³Ø­Øª
            gameData = data;

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù„ÙˆØ¨ÙŠ
            if(data.status === 'waiting') {
                updateLobby(data.players);
            } else if (data.status === 'playing') {
                if(!document.getElementById('screen-game').classList.contains('hidden') === false) {
                    showScreen('screen-game'); // Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ù„Ù„Ø´Ø§Ø´Ø©
                    document.getElementById('screen-game').classList.remove('hidden');
                    document.querySelector('.container').style.justifyContent = 'flex-start';
                }
                updateGameUI(data);
            } else if (data.status === 'finished') {
                alert("Ø§Ù„Ø¬ÙŠÙ… Ø®Ù„Øµ!");
                location.reload();
            }

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´Ø§Øª
            updateChat(data.chat);
        });
    }

    function updateLobby(players) {
        const list = document.getElementById('lobby-list');
        list.innerHTML = "";
        Object.values(players || {}).forEach(p => {
            list.innerHTML += `<li style="margin:5px; border-bottom:1px solid #ccc; padding:5px">ğŸ‘¤ ${p.name}</li>`;
        });
    }

    // --- Ù…Ù†Ø·Ù‚ Ø§Ù„Ù„Ø¹Ø¨Ø© ---
    function startGame() {
        const pIds = Object.keys(gameData.players);
        const count = pIds.length;
        if(count < 2) return alert("Ù„Ø§Ø²Ù… 2 Ø¹ Ø§Ù„Ø£Ù‚Ù„");

        // 1. ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø¯ÙˆÙ…ÙŠÙ†Ùˆ
        let tiles = [];
        for(let i=0; i<=6; i++) {
            for(let j=i; j<=6; j++) {
                tiles.push({a: i, b: j});
            }
        }

        let handSize = 7;
        // Ø­Ø°Ù 0/0 ÙÙŠ Ø­Ø§Ù„Ø© 3 Ù„Ø§Ø¹Ø¨ÙŠÙ†
        if(count === 3) {
            tiles = tiles.filter(t => !(t.a === 0 && t.b === 0));
            handSize = 9;
        }

        // Ø®Ù„Ø·
        tiles.sort(() => Math.random() - 0.5);

        // ØªÙˆØ²ÙŠØ¹
        const updates = {};
        pIds.forEach(id => {
            const hand = tiles.splice(0, handSize);
            updates[`players/${id}/hand`] = hand;
            updates[`players/${id}/count`] = handSize;
        });

        updates['stock'] = tiles;
        updates['board'] = [];
        updates['status'] = 'playing';
        updates['turnIndex'] = 0;

        db.ref('rooms/' + currentRoom).update(updates);
    }

    function updateGameUI(data) {
        const pIds = Object.keys(data.players);
        const myPlayer = data.players[myId];
        
        // 1. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø®ØµÙˆÙ…
        const oppArea = document.getElementById('opponents-area');
        oppArea.innerHTML = "";
        
        pIds.forEach((id, idx) => {
            if(id === myId) return; // Ù„Ø§ ØªØ¹Ø±Ø¶ Ù†ÙØ³ÙŠ Ù‡Ù†Ø§
            const p = data.players[id];
            const isTurn = (pIds[data.turnIndex] === id);
            
            oppArea.innerHTML += `
                <div class="player-card ${isTurn ? 'active-turn' : ''}">
                    <div>${p.name}</div>
                    <div class="card-count">${p.count || 0} ğŸ€„</div>
                </div>
            `;
        });

        // 2. Ù…Ù† Ø¹Ù„ÙŠÙ‡ Ø§Ù„Ø¯ÙˆØ±
        const currentTurnId = pIds[data.turnIndex];
        const turnName = data.players[currentTurnId].name;
        document.getElementById('turn-info').innerText = (currentTurnId === myId) ? "âœ¨ Ø¯ÙˆØ±Ùƒ âœ¨" : `Ø¯ÙˆØ±: ${turnName}`;

        // 3. ØªØ­Ø¯ÙŠØ« ÙŠØ¯ÙŠ
        renderHand(myPlayer.hand || []);

        // 4. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø·Ø§ÙˆÙ„Ø©
        renderBoard(data.board || []);

        // 5. Ø²Ø± Ø§Ù„Ø³Ø­Ø¨
        const btn = document.getElementById('draw-btn');
        if(currentTurnId === myId && (!data.stock || data.stock.length > 0)) {
            // Ù‡Ù†Ø§ Ø§Ù„Ù…ÙØ±ÙˆØ¶ Ù†Ø¹Ù…Ù„ ÙØ­Øµ Ù…Ù†Ø·Ù‚ÙŠ Ù‡Ù„ Ù…Ø¹Ø§Ù‡ ÙˆØ±Ù‚ ÙŠÙ„Ø¹Ø¨ ÙˆÙ„Ø§ Ù„Ø£ØŒ Ø¨Ø³ Ù‡Ù†Ø®Ù„ÙŠÙ‡ Ø¸Ø§Ù‡Ø± ÙƒØ®ÙŠØ§Ø±
            btn.classList.remove('hidden');
            btn.innerText = `Ø³Ø­Ø¨ (ÙÙŠ Ø§Ù„Ø£Ø±Ø¶ ${data.stock ? data.stock.length : 0})`;
            btn.onclick = drawTile;
        } else {
            btn.classList.add('hidden');
        }
    }

    // --- Ø§Ù„Ø±Ø³Ù… (Rendering) ---
    
    // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø±Ø³Ù… Ø§Ù„Ù†Ù‚Ø§Ø·
    function getPipsHtml(num) {
        if(num === 0) return ""; 
        let html = "";
        // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù†Ù‚Ø§Ø· Ø¨Ù†Ø§Ø¡ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ù‚Ù…
        const configs = {
            1: ['p1'],
            2: ['p2-1', 'p2-2'],
            3: ['p3-1', 'p3-2', 'p3-3'],
            4: ['p4-1', 'p4-2', 'p4-3', 'p4-4'],
            5: ['p5-1', 'p5-2', 'p5-3', 'p5-4', 'p5-5'],
            6: ['p6-1', 'p6-2', 'p6-3', 'p6-4', 'p6-5', 'p6-6']
        };
        configs[num].forEach(cls => {
            html += `<div class="pip ${cls}"></div>`;
        });
        return html;
    }

    function renderHand(hand) {
        const div = document.getElementById('my-hand-area');
        div.innerHTML = "";
        hand.forEach((tile, idx) => {
            div.innerHTML += `
                <div class="domino hand-tile" onclick="playTile(${idx})">
                    <div class="pip-container">${getPipsHtml(tile.a)}</div>
                    <div class="line"></div>
                    <div class="pip-container">${getPipsHtml(tile.b)}</div>
                </div>
            `;
        });
    }

    function renderBoard(board) {
        const div = document.getElementById('game-board');
        div.innerHTML = "";
        if(board.length === 0) {
            div.innerHTML = "<span style='color:rgba(255,255,255,0.2)'>Ø§Ù„Ø·Ø§ÙˆÙ„Ø© ÙØ§Ø±ØºØ©</span>";
            return;
        }

        board.forEach(tile => {
            // ÙØ­Øµ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„ÙˆØ±Ù‚Ø© "Ø¨ÙÙØ©" (Ø±Ù‚Ù…ÙŠÙ† Ù…ØªØ´Ø§Ø¨Ù‡ÙŠÙ†)
            const isDouble = (tile.a === tile.b);
            const cssClass = isDouble ? "board-tile double" : "board-tile";
            
            // ÙÙŠ Ø§Ù„Ø¨Ù„Ø§Ø·Ø© Ø§Ù„ÙˆØ§Ù‚ÙØ© (double)ØŒ Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø£ÙˆÙ„ Ø¨ÙŠÙƒÙˆÙ† ÙÙˆÙ‚
            // ÙÙŠ Ø§Ù„Ø¨Ù„Ø§Ø·Ø© Ø§Ù„Ù†Ø§ÙŠÙ…Ø©ØŒ Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø£ÙˆÙ„ Ø¨ÙŠÙƒÙˆÙ† Ø´Ù…Ø§Ù„
            div.innerHTML += `
                <div class="domino ${cssClass}">
                    <div class="pip-container">${getPipsHtml(tile.a)}</div>
                    <div class="line"></div>
                    <div class="pip-container">${getPipsHtml(tile.b)}</div>
                </div>
            `;
        });
    }

    // --- ØªÙØ§Ø¹Ù„Ø§Øª Ø§Ù„Ù„Ø¹Ø¨ ---
    function playTile(idx) {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¯ÙˆØ±
        const pIds = Object.keys(gameData.players);
        if(pIds[gameData.turnIndex] !== myId) return alert("Ø§ØµØ¨Ø± Ù…Ø´ Ø¯ÙˆØ±Ùƒ!");

        const myHand = gameData.players[myId].hand;
        const tile = myHand[idx];
        let board = gameData.board || [];
        
        let newBoard = [...board];
        let played = false;

        if (board.length === 0) {
            newBoard.push(tile);
            played = true;
        } else {
            const leftVal = newBoard[0].a;
            const rightVal = newBoard[newBoard.length-1].b;

            // Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ±ÙƒÙŠØ¨ ÙŠÙ…ÙŠÙ†
            if (tile.a === rightVal) {
                newBoard.push(tile);
                played = true;
            } else if (tile.b === rightVal) {
                // Ù‚Ù„Ø¨ Ø§Ù„ÙˆØ±Ù‚Ø© Ù„ØªÙ†Ø§Ø³Ø¨
                newBoard.push({a: tile.b, b: tile.a});
                played = true;
            } 
            // Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ±ÙƒÙŠØ¨ ÙŠØ³Ø§Ø±
            else if (tile.b === leftVal) {
                newBoard.unshift(tile);
                played = true;
            } else if (tile.a === leftVal) {
                // Ù‚Ù„Ø¨
                newBoard.unshift({a: tile.b, b: tile.a});
                played = true;
            }
        }

        if(played) {
            myHand.splice(idx, 1);
            let nextTurn = (gameData.turnIndex + 1) % pIds.length;
            
            const updates = {
                board: newBoard,
                turnIndex: nextTurn,
                [`players/${myId}/hand`]: myHand,
                [`players/${myId}/count`]: myHand.length
            };

            if(myHand.length === 0) updates['status'] = 'finished';

            db.ref('rooms/' + currentRoom).update(updates);
        } else {
            alert("Ø§Ù„ÙˆØ±Ù‚Ø© Ø¯ÙŠ Ù…Ø´ Ø¨ØªØ±ÙƒØ¨!");
        }
    }

    function drawTile() {
        let stock = gameData.stock || [];
        if(stock.length === 0) return alert("Ù…ÙÙŠØ´ ÙˆØ±Ù‚ ÙÙŠ Ø§Ù„Ø£Ø±Ø¶");
        
        const card = stock.pop();
        const myHand = gameData.players[myId].hand || [];
        myHand.push(card);

        db.ref('rooms/' + currentRoom).update({
            stock: stock,
            [`players/${myId}/hand`]: myHand,
            [`players/${myId}/count`]: myHand.length
        });
    }

    // --- Ø§Ù„Ø´Ø§Øª ---
    function toggleChat() {
        const win = document.getElementById('chat-window');
        const badge = document.getElementById('chat-badge');
        
        if(win.classList.contains('hidden')) {
            win.classList.remove('hidden');
            chatOpen = true;
            unreadCount = 0;
            badge.classList.add('hidden');
            scrollToBottom();
        } else {
            win.classList.add('hidden');
            chatOpen = false;
        }
    }

    function sendMsg() {
        const input = document.getElementById('chat-input');
        const txt = input.value.trim();
        if(!txt) return;

        db.ref(`rooms/${currentRoom}/chat`).push({
            name: myName, text: txt
        });
        input.value = "";
    }

    function updateChat(chatData) {
        if(!chatData) return;
        const box = document.getElementById('chat-messages');
        const badge = document.getElementById('chat-badge');
        
        // Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ù„Ù„ØªØ£ÙƒØ¯ Ù‡Ù„ Ù‡Ù†Ø§Ùƒ Ø¬Ø¯ÙŠØ¯
        const msgs = Object.values(chatData);
        const prevCount = box.childElementCount;

        if (msgs.length > prevCount) {
             // Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©
             if(!chatOpen) {
                 unreadCount++;
                 badge.innerText = unreadCount;
                 badge.classList.remove('hidden');
             }
        }

        box.innerHTML = "";
        msgs.forEach(m => {
            const isMine = (m.name === myName);
            box.innerHTML += `<div class="chat-msg ${isMine ? 'mine' : ''}"><strong>${m.name}:</strong> ${m.text}</div>`;
        });
        
        if(chatOpen) scrollToBottom();
    }

    function scrollToBottom() {
        const box = document.getElementById('chat-messages');
        box.scrollTop = box.scrollHeight;
    }

</script>
</body>
</html>
