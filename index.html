<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„Ø¹Ø¨Ø© Ø¯ÙŠØ³ÙƒÙŠØª - Dixit Online</title>
    <style>
        /* --- ØªÙ†Ø³ÙŠÙ‚Ø§Øª CSS --- */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #2c3e50; color: white; text-align: center; margin: 0; padding: 20px; }
        
        h1 { color: #f1c40f; }
        
        /* Ø´Ø§Ø´Ø§Øª Ø§Ù„Ù„Ø¹Ø¨Ø© */
        #login-screen, #game-screen { display: none; }
        .active { display: block !important; }

        /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙˆØ§Ù„Ù…Ø¯Ø®Ù„Ø§Øª */
        input { padding: 10px; font-size: 16px; border-radius: 5px; border: none; }
        button { padding: 10px 20px; font-size: 16px; background-color: #e67e22; color: white; border: none; border-radius: 5px; cursor: pointer; margin-top: 10px; }
        button:hover { background-color: #d35400; }

        /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ÙƒØ±ÙˆØª */
        .cards-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; margin-top: 20px; }
        .card { width: 150px; height: 220px; border-radius: 10px; overflow: hidden; border: 3px solid transparent; cursor: pointer; transition: transform 0.2s; background: #fff; }
        .card img { width: 100%; height: 100%; object-fit: cover; }
        .card:hover { transform: scale(1.05); }
        .card.selected { border-color: #2ecc71; transform: scale(1.1); box-shadow: 0 0 15px #2ecc71; }

        /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø­Ø§Ù„Ø© */
        #status-bar { background: rgba(0,0,0,0.5); padding: 15px; border-radius: 10px; margin-bottom: 20px; }
        .role-tag { font-weight: bold; color: #f39c12; }
    </style>
</head>
<body>

    <h1>ğŸ­ Dixit Odyssey ğŸ­</h1>

    <div id="login-screen" class="active">
        <h3>Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ù„Ù„Ø§Ù†Ø¶Ù…Ø§Ù…</h3>
        <input type="text" id="username" placeholder="Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨">
        <button onclick="joinGame()">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù„Ø¹Ø¨Ø©</button>
    </div>

    <div id="game-screen">
        <div id="status-bar">
            <p>Ù…Ø±Ø­Ø¨Ø§Ù‹ <span id="player-name-display"></span> | Ø£Ù†Øª: <span id="player-role" class="role-tag">Ø§Ù†ØªØ¸Ø±...</span></p>
            <h2 id="game-instruction">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø©...</h2>
            <div id="clue-display" style="display:none; font-size: 1.2em; color: #add8e6;"></div>
        </div>

        <div id="storyteller-area" style="display:none;">
            <input type="text" id="clue-input" placeholder="Ø§ÙƒØªØ¨ ÙˆØµÙØ§Ù‹ Ù„Ù„ÙƒØ§Ø±Øª Ø§Ù„Ù…Ø®ØªØ§Ø±...">
            <button onclick="submitClue()">ØªØ£ÙƒÙŠØ¯ Ø§Ù„ÙˆØµÙ ÙˆØ§Ù„ÙƒØ§Ø±Øª</button>
        </div>

        <div id="table-area" style="display:none;">
            <h3>Ø§Ù„ÙƒØ±ÙˆØª Ø¹Ù„Ù‰ Ø§Ù„Ø·Ø§ÙˆÙ„Ø© (Ø§Ø®ØªØ± Ø§Ù„ÙƒØ§Ø±Øª Ø§Ù„ØµØ­ÙŠØ­)</h3>
            <div id="table-cards" class="cards-container"></div>
            <button onclick="submitVote()" id="vote-btn" style="display:none;">ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªØµÙˆÙŠØª</button>
        </div>

        <div id="hand-area">
            <h3>ÙƒØ±ÙˆØªÙƒ</h3>
            <div id="my-hand" class="cards-container"></div>
            <button onclick="playCard()" id="play-card-btn" style="display:none;">Ø§Ù„Ø¹Ø¨ Ø§Ù„ÙƒØ§Ø±Øª Ø§Ù„Ù…Ø­Ø¯Ø¯</button>
        </div>
    </div>

    <script type="module">
        // Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…ÙƒØªØ¨Ø§Øª Firebase (ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø­Ø¯ÙŠØ«Ø©)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc, arrayUnion, getDoc } 
        from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // âš ï¸ Ù‡Ø§Ù…: Ø§Ø³ØªØ¨Ø¯Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø¬Ø²Ø¡ Ø¨Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ø´Ø±ÙˆØ¹Ùƒ Ù…Ù† Firebase Console
        const firebaseConfig = {
        apiKey: "AIzaSyCp9_P3K__Sr76iKgaVG1iD4NluUqPtni4",
authDomain: "heka-codenames.firebaseapp.com",
databaseURL: "https://heka-codenames-default-rtdb.firebaseio.com",
projectId: "heka-codenames",
storageBucket: "heka-codenames.firebasestorage.app",
messagingSenderId: "901713932504",
appId: "1:901713932504:web:b6710ddf537cd3c7c4e7ad"

        };

        // ØªÙ‡ÙŠØ¦Ø© Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const ROOM_ID = "dixit_room_1"; // Ø³Ù†Ø³ØªØ®Ø¯Ù… ØºØ±ÙØ© ÙˆØ§Ø­Ø¯Ø© Ù„Ù„ØªØ¨Ø³ÙŠØ·

        // Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù„Ø¹Ø¨Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ©
        let myName = "";
        let myCards = [];
        let selectedCard = null;
        let currentGameState = {};

        // Ù‚Ø§Ø¦Ù…Ø© ØµÙˆØ± ØªØ¬Ø±ÙŠØ¨ÙŠØ© (ØµÙˆØ± Ø¹Ø´ÙˆØ§Ø¦ÙŠØ© Ù…Ù† Unsplash)
        const imageDeck = Array.from({length: 30}, (_, i) => `https://picsum.photos/300/400?random=${i}`);

        // 1. ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„Ø¹Ø¨Ø©
        window.joinGame = async () => {
            const inputName = document.getElementById("username").value;
            if (!inputName) return alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø§Ø³Ù…");
            
            myName = inputName;
            document.getElementById("player-name-display").innerText = myName;
            document.getElementById("login-screen").classList.remove("active");
            document.getElementById("game-screen").classList.add("active");

            // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            const roomRef = doc(db, "games", ROOM_ID);
            const roomSnap = await getDoc(roomRef);

            if (!roomSnap.exists()) {
                // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØºØ±ÙØ© Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø© (Ø£ÙˆÙ„ Ù„Ø§Ø¹Ø¨)
                await setDoc(roomRef, {
                    players: [myName],
                    storyteller: myName, // Ø§Ù„Ø£ÙˆÙ„ Ù‡Ùˆ Ø§Ù„Ø­ÙƒÙˆØ§ØªÙŠ
                    phase: "waiting", // waiting, clue, playing, voting
                    clue: "",
                    tableCards: [], // {player: name, img: url}
                    votes: {},
                    deckIndex: 0
                });
            } else {
                // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù„Ø§Ø¹Ø¨ Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©
                await updateDoc(roomRef, {
                    players: arrayUnion(myName)
                });
            }

            // ØªÙˆØ²ÙŠØ¹ ÙƒØ±ÙˆØª Ù…Ø¨Ø¯Ø¦ÙŠØ© Ù„Ù„Ø§Ø¹Ø¨ (Ù…Ø­Ø§ÙƒØ§Ø©)
            dealCards();
            
            // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„ØªØºÙŠÙŠØ±Ø§Øª ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Real-time Listener)
            listenToGame();
        };

        function dealCards() {
            // ÙÙŠ Ø§Ù„Ù„Ø¹Ø¨Ø© Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© ÙŠØ¬Ø¨ Ø³Ø­Ø¨ Ø§Ù„ÙƒØ±ÙˆØª Ù…Ù† Ø§Ù„Ø¯ÙŠÙƒ Ø§Ù„Ù…Ø´ØªØ±ÙƒØŒ Ù‡Ù†Ø§ Ø³Ù†Ø¹Ø·ÙŠ ÙƒØ±ÙˆØª Ø¹Ø´ÙˆØ§Ø¦ÙŠØ© Ù„Ù„ØªØ¨Ø³ÙŠØ·
            myCards = [];
            for(let i=0; i<6; i++) {
                myCards.push(imageDeck[Math.floor(Math.random() * imageDeck.length)]);
            }
            renderHand();
        }

        // 2. Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ø§Ù„Ù„Ø­Ø¸ÙŠ Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©
        function listenToGame() {
            onSnapshot(doc(db, "games", ROOM_ID), (doc) => {
                currentGameState = doc.data();
                updateUI();
            });
        }

        // 3. ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø§Ù„Ø©
        function updateUI() {
            const isStoryteller = currentGameState.storyteller === myName;
            const phase = currentGameState.phase;
            const instruction = document.getElementById("game-instruction");
            const roleEl = document.getElementById("player-role");
            
            roleEl.innerText = isStoryteller ? "Ø§Ù„Ø­ÙƒÙˆØ§ØªÙŠ ğŸ©" : "Ù„Ø§Ø¹Ø¨ Ù…Ø´Ø§Ø±Ùƒ ğŸ•µï¸";

            // Ø¥Ø®ÙØ§Ø¡/Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø­Ø³Ø¨ Ø§Ù„Ù…Ø±Ø­Ù„Ø©
            document.getElementById("storyteller-area").style.display = "none";
            document.getElementById("table-area").style.display = "none";
            document.getElementById("play-card-btn").style.display = "none";
            document.getElementById("clue-display").style.display = "none";

            if (phase === "waiting") {
                instruction.innerText = `ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†... (Ø§Ù„Ø¹Ø¯Ø¯: ${currentGameState.players.length})`;
                if (isStoryteller && currentGameState.players.length >= 2) { 
                    // Ø²Ø± Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø© (ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØªÙ‡) Ù„ÙƒÙ† Ø³Ù†Ù†ØªÙ‚Ù„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù„Ù„ØªØ¬Ø±Ø¨Ø©
                   startGamePhase();
                }
            } 
            else if (phase === "clue") {
                if (isStoryteller) {
                    instruction.innerText = "Ø§Ø®ØªØ± ÙƒØ§Ø±ØªØ§Ù‹ ÙˆØ§ÙƒØªØ¨ ÙˆØµÙØ§Ù‹ Ù„Ù‡!";
                    document.getElementById("storyteller-area").style.display = "block";
                } else {
                    instruction.innerText = `Ø§Ù„Ø­ÙƒÙˆØ§ØªÙŠ ${currentGameState.storyteller} ÙŠÙÙƒØ± ÙÙŠ ÙˆØµÙ...`;
                }
            }
            else if (phase === "playing") {
                document.getElementById("clue-display").innerText = `Ø§Ù„ÙˆØµÙ: "${currentGameState.clue}"`;
                document.getElementById("clue-display").style.display = "block";
                
                if (isStoryteller) {
                     instruction.innerText = "Ø§Ù„Ù„Ø§Ø¹Ø¨ÙˆÙ† ÙŠØ®ØªØ§Ø±ÙˆÙ† ÙƒØ±ÙˆØªÙ‡Ù…...";
                } else {
                    // Ù‡Ù„ Ù„Ø¹Ø¨Øª ÙˆØ±Ù‚ØªÙŠ Ø¨Ø§Ù„ÙØ¹Ù„ØŸ
                    const played = currentGameState.tableCards.find(c => c.player === myName);
                    if (!played) {
                        instruction.innerText = "Ø§Ø®ØªØ± ÙƒØ§Ø±ØªØ§Ù‹ Ù…Ù† ÙŠØ¯Ùƒ ÙŠÙ†Ø§Ø³Ø¨ Ø§Ù„ÙˆØµÙ!";
                        document.getElementById("play-card-btn").style.display = "inline-block";
                    } else {
                        instruction.innerText = "ØªÙ… Ø§Ø®ØªÙŠØ§Ø± ÙƒØ§Ø±ØªÙƒØŒ ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¨Ù‚ÙŠØ©...";
                    }
                }
            }
            else if (phase === "voting") {
                instruction.innerText = "ØµÙˆÙ‘Øª Ù„Ù„ÙƒØ§Ø±Øª Ø§Ù„Ø°ÙŠ ØªØ¹ØªÙ‚Ø¯ Ø£Ù†Ù‡ Ù„Ù„Ø­ÙƒÙˆØ§ØªÙŠ!";
                document.getElementById("table-area").style.display = "block";
                renderTableCards(); // Ø¹Ø±Ø¶ Ø§Ù„ÙƒØ±ÙˆØª Ù„Ù„ØªØµÙˆÙŠØª
                if (!isStoryteller) {
                    document.getElementById("vote-btn").style.display = "inline-block";
                }
            }
        }

        // 4. ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ØªÙØ§Ø¹Ù„ (Buttons Actions)

        // Ø±Ø³Ù… ÙƒØ±ÙˆØª Ø§Ù„ÙŠØ¯
        function renderHand() {
            const container = document.getElementById("my-hand");
            container.innerHTML = "";
            myCards.forEach(imgUrl => {
                const div = document.createElement("div");
                div.className = "card";
                div.innerHTML = `<img src="${imgUrl}">`;
                div.onclick = () => {
                    document.querySelectorAll(".card").forEach(c => c.classList.remove("selected"));
                    div.classList.add("selected");
                    selectedCard = imgUrl;
                };
                container.appendChild(div);
            });
        }

        // Ø§Ù„Ø­ÙƒÙˆØ§ØªÙŠ ÙŠØ±Ø³Ù„ Ø§Ù„ÙˆØµÙ ÙˆØ§Ù„ÙƒØ§Ø±Øª
        window.submitClue = async () => {
            const clueText = document.getElementById("clue-input").value;
            if (!selectedCard || !clueText) return alert("Ø§Ø®ØªØ± ÙƒØ§Ø±Øª ÙˆØ§ÙƒØªØ¨ ÙˆØµÙ");

            await updateDoc(doc(db, "games", ROOM_ID), {
                clue: clueText,
                phase: "playing",
                tableCards: arrayUnion({player: myName, img: selectedCard, type: 'storyteller'})
            });
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ÙƒØ§Ø±Øª Ù…Ù† Ø§Ù„ÙŠØ¯ Ù…Ø­Ù„ÙŠØ§Ù‹
            removeCardFromHand(selectedCard);
        };

        // ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨ (Ù…Ø¤Ù‚Øª Ù„Ù„ØªØ¬Ø±Ø¨Ø©)
        async function startGamePhase() {
           // ÙÙŠ Ø§Ù„ÙˆØ§Ù‚Ø¹ Ù†Ø­ØªØ§Ø¬ Ø²Ø± "Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨Ø©"
           if(currentGameState.phase === 'waiting') {
               await updateDoc(doc(db, "games", ROOM_ID), { phase: "clue" });
           }
        }

        // Ø§Ù„Ù„Ø§Ø¹Ø¨ ÙŠØ±Ù…ÙŠ ÙƒØ§Ø±ØªÙ‡
        window.playCard = async () => {
            if (!selectedCard) return alert("Ø§Ø®ØªØ± ÙƒØ§Ø±Øª");
            
            await updateDoc(doc(db, "games", ROOM_ID), {
                tableCards: arrayUnion({player: myName, img: selectedCard, type: 'player'})
            });
            removeCardFromHand(selectedCard);

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù‡Ù„ Ø§Ù„Ø¬Ù…ÙŠØ¹ Ù„Ø¹Ø¨ØŸ (Ø¨Ø³ÙŠØ·)
            // if tableCards.length == players.length -> move to voting
            // Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†Ø·Ù‚ ÙŠÙØ¶Ù„ Ø£Ù† ÙŠÙƒÙˆÙ† ÙÙŠ Cloud Functions Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø£Ù…Ø§Ù†ØŒ Ù„ÙƒÙ† ÙŠÙ…ÙƒÙ† Ø¹Ù…Ù„Ù‡ Ù‡Ù†Ø§
            if (currentGameState.tableCards.length + 1 >= currentGameState.players.length) {
                 await updateDoc(doc(db, "games", ROOM_ID), { phase: "voting" });
            }
        };

        function removeCardFromHand(url) {
            myCards = myCards.filter(c => c !== url);
            renderHand();
            selectedCard = null;
        }

        // Ø¹Ø±Ø¶ ÙƒØ±ÙˆØª Ø§Ù„Ø·Ø§ÙˆÙ„Ø© Ù„Ù„ØªØµÙˆÙŠØª
        function renderTableCards() {
            const container = document.getElementById("table-cards");
            container.innerHTML = "";
            // ÙŠØ¬Ø¨ Ø®Ù„Ø· Ø§Ù„ÙƒØ±ÙˆØª Ù‡Ù†Ø§ Ø­ØªÙ‰ Ù„Ø§ ÙŠØ¹Ø±Ù Ø£Ø­Ø¯ ÙƒØ§Ø±Øª Ø§Ù„Ø­ÙƒÙˆØ§ØªÙŠ
            // Ø³Ù†Ø¹Ø±Ø¶Ù‡Ø§ ÙƒÙ…Ø§ Ù‡ÙŠ Ù„Ù„ØªØ¨Ø³ÙŠØ·
            currentGameState.tableCards.forEach(cardObj => {
                const div = document.createElement("div");
                div.className = "card";
                div.innerHTML = `<img src="${cardObj.img}">`;
                
                // Ù„Ø§ ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ø§Ù„ØªØµÙˆÙŠØª Ù„Ù†ÙØ³ÙŠ
                if (cardObj.player !== myName) {
                    div.onclick = () => {
                        document.querySelectorAll("#table-cards .card").forEach(c => c.classList.remove("selected"));
                        div.classList.add("selected");
                        selectedCard = cardObj.player; // Ù†ØµÙˆØª Ù„Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨ ØµØ§Ø­Ø¨ Ø§Ù„ÙƒØ§Ø±Øª
                    };
                } else {
                    div.style.opacity = "0.5"; // ÙƒØ§Ø±ØªÙŠ Ø£Ù†Ø§
                    div.style.cursor = "default";
                }
                container.appendChild(div);
            });
        }

        window.submitVote = async () => {
            if(!selectedCard) return alert("Ù…Ù† ÙØ¶Ù„Ùƒ ØµÙˆÙ‘Øª Ù„ÙƒØ§Ø±Øª");
            // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØµÙˆÙŠØª...
            alert("ØªÙ… Ø§Ù„ØªØµÙˆÙŠØª! (Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¬ÙˆÙ„Ø© Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ©)");
            // Ù‡Ù†Ø§ ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Score ÙˆØ§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù…Ø±Ø­Ù„Ø© clue Ù…Ø¹ Ø­ÙƒÙˆØ§ØªÙŠ Ø¬Ø¯ÙŠØ¯
        };

    </script>
</body>
</html>
