<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DOMINO HEKA PRO</title>
    <link href="https://fonts.googleapis.com/css2?family=Righteous&family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    
    <style>
        :root { 
            --bg-color: #0f172a; 
            --glass-bg: rgba(30, 41, 59, 0.9);
            --domino-white: #f1f2f6;
            --domino-black: #1e272e;
            --accent-color: #3b82f6; 
            --gold: #fbbf24;
            --danger: #ef4444;
        }

        body { 
            font-family: 'Cairo', sans-serif; 
            background-color: var(--bg-color);
            background-image: radial-gradient(#1e293b 15%, transparent 16%), radial-gradient(#1e293b 15%, transparent 16%);
            background-size: 60px 60px;
            color: #e2e8f0; margin: 0; overflow: hidden; height: 100vh;
            display: flex; flex-direction: column; user-select: none;
        }

        h1.game-title {
            font-family: 'Righteous', cursive; font-size: 2rem; color: var(--gold);
            text-shadow: 0 0 15px rgba(251, 191, 36, 0.4); margin: 5px 0; text-align: center;
        }

        .container { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; position: relative; }
        .hidden { display: none !important; }

        /* Ø§Ù„Ø´Ø§Ø´Ø§Øª */
        .screen {
            background: var(--glass-bg); backdrop-filter: blur(12px); padding: 30px;
            border-radius: 20px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.6);
            border: 1px solid rgba(255,255,255,0.1); width: 90%; max-width: 400px;
        }

        /* Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªØ­ÙƒÙ… */
        input { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); padding: 10px; color: white; border-radius: 8px; text-align: center; outline: none; }
        button { background: var(--accent-color); color: white; padding: 10px 20px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.3s; margin: 5px; font-family: 'Cairo'; }
        button:hover { transform: scale(1.05); }

        /* Ø§Ù„Ø¯ÙˆÙ…ÙŠÙ†Ùˆ */
        .domino { background-color: var(--domino-white); border-radius: 4px; box-shadow: 2px 2px 0px #777; display: flex; cursor: pointer; position: relative; }
        .pip-container { display: grid; grid-template-columns: repeat(3, 1fr); grid-template-rows: repeat(3, 1fr); padding: 2px; width: 100%; height: 100%; box-sizing: border-box; }
        .pip { background-color: var(--domino-black); border-radius: 50%; width: 100%; height: 100%; box-shadow: inset 0 1px 1px rgba(0,0,0,0.5); }
        .line { background-color: #ccc; }

        /* ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù†Ù‚Ø§Ø· */
        .p1 { grid-area: 2 / 2; }
        .p2-1 { grid-area: 1 / 3; } .p2-2 { grid-area: 3 / 1; }
        .p3-1 { grid-area: 1 / 3; } .p3-2 { grid-area: 2 / 2; } .p3-3 { grid-area: 3 / 1; }
        .p4-1 { grid-area: 1 / 1; } .p4-2 { grid-area: 1 / 3; } .p4-3 { grid-area: 3 / 1; } .p4-4 { grid-area: 3 / 3; }
        .p5-1 { grid-area: 1 / 1; } .p5-2 { grid-area: 1 / 3; } .p5-3 { grid-area: 2 / 2; } .p5-4 { grid-area: 3 / 1; } .p5-5 { grid-area: 3 / 3; }
        .p6-1 { grid-area: 1 / 1; } .p6-2 { grid-area: 1 / 3; } .p6-3 { grid-area: 2 / 1; } .p6-4 { grid-area: 2 / 3; } .p6-5 { grid-area: 3 / 1; } .p6-6 { grid-area: 3 / 3; }

        /* Ø§Ù„Ø£Ø­Ø¬Ø§Ù… */
        .hand-tile { width: 34px; height: 68px; flex-direction: column; margin: 0 3px; }
        .hand-tile .line { height: 2px; width: 90%; margin: 2px auto; }
        .hand-tile .pip-container { width: 34px; height: 33px; } .hand-tile .pip { width: 6px; height: 6px; margin: auto; }

        .board-tile { width: 60px; height: 30px; flex-direction: row; margin: 0 1px; }
        .board-tile .line { width: 2px; height: 90%; margin: auto 2px; }
        .board-tile .pip-container { width: 29px; height: 30px; } .board-tile .pip { width: 5px; height: 5px; margin: auto; }

        .board-tile.double { width: 30px; height: 60px; flex-direction: column; margin: 0 2px; transform: translateY(-10px); }
        .board-tile.double .line { height: 2px; width: 90%; margin: 2px auto; }
        .board-tile.double .pip-container { width: 30px; height: 29px; }

        /* ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù„Ø¹Ø¨ */
        #game-interface { width: 100%; height: 100%; display: flex; flex-direction: column; }
        #table-surface {
            flex: 1; margin: 10px; border-radius: 20px; border: 4px solid #334155;
            background: rgba(15, 23, 42, 0.5); display: flex; justify-content: center; align-items: center;
            position: relative; box-shadow: inset 0 0 50px black; overflow: hidden;
        }
        #game-board { display: flex; align-items: center; transition: transform 0.3s; padding: 50px; }

        /* Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† */
        .player-pos {
            position: absolute; background: rgba(30, 41, 59, 0.95); padding: 8px 12px;
            border-radius: 10px; display: flex; flex-direction: column; align-items: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5); min-width: 90px;
        }
        .player-pos.active-turn { border: 2px solid var(--gold); box-shadow: 0 0 15px var(--gold); }
        .p-score { color: var(--gold); font-weight: bold; font-size: 14px; }
        .pos-top { top: 10px; left: 50%; transform: translateX(-50%); }
        .pos-left { top: 50%; left: 10px; transform: translateY(-50%); }
        .pos-right { top: 50%; right: 10px; transform: translateY(-50%); }
        .timer-bar { height: 3px; background: var(--danger); width: 100%; margin-top: 5px; transition: width 1s linear; }

        /* Ù…Ù†Ø·Ù‚ØªÙŠ */
        #my-area { height: 130px; background: rgba(0,0,0,0.7); display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; border-top: 1px solid #444; }
        #my-hand { display: flex; overflow-x: auto; padding: 10px; max-width: 100%; }
        #draw-btn { position: absolute; top: -50px; background: var(--gold); color: black; z-index: 50; box-shadow: 0 0 10px var(--gold); }

        /* Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ (Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©) */
        #choice-modal { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index: 300; display:flex; flex-direction:column; justify-content:center; align-items:center; }
        .side-btn { font-size: 20px; padding: 20px 40px; margin: 10px; background: var(--accent-color); color: white; border: none; border-radius: 10px; cursor: pointer; }

        /* Ø§Ù„Ø´Ø§Øª */
        #chat-icon { position: fixed; bottom: 20px; left: 20px; width: 50px; height: 50px; background: var(--accent-color); border-radius: 50%; display: flex; justify-content: center; align-items: center; cursor: pointer; z-index: 200; }
        #chat-badge { position: absolute; top: -5px; right: -5px; background: red; color: white; width: 20px; height: 20px; border-radius: 50%; font-size: 12px; display: flex; justify-content: center; align-items: center; }
        #chat-box { position: fixed; bottom: 80px; left: 20px; width: 280px; height: 300px; background: var(--glass-bg); border-radius: 10px; display: flex; flex-direction: column; z-index: 200; }
        #chat-msgs { flex: 1; overflow-y: auto; padding: 10px; }
        .msg { background: rgba(255,255,255,0.1); padding: 5px; margin: 3px 0; border-radius: 5px; font-size: 13px; text-align: right; }
        .msg.mine { background: rgba(59, 130, 246, 0.4); align-self: flex-end; }
    </style>
</head>
<body>

    <h1 class="game-title">DOMINO HEKA PRO</h1>

    <div id="choice-modal" class="hidden">
        <h2 style="color:white">Ø§ÙŠÙ† ØªØ±ÙŠØ¯ ÙˆØ¶Ø¹ Ø§Ù„ÙˆØ±Ù‚Ø©ØŸ</h2>
        <div style="display:flex;">
            <button class="side-btn" onclick="resolveChoice('right')">ÙŠÙ…ÙŠÙ† ğŸ‘‰</button>
            <button class="side-btn" onclick="resolveChoice('left')">ğŸ‘ˆ ÙŠØ³Ø§Ø±</button>
        </div>
    </div>

    <div id="screen-winner" class="screen hidden" style="position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); z-index:400; border:2px solid var(--gold);">
        <h1 style="color:var(--gold); font-size:3rem;">ğŸ† CHAMPION ğŸ†</h1>
        <h2 id="winner-name"></h2>
        <button onclick="leaveRoom()">Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
    </div>

    <div class="container">
        <div id="screen-login" class="screen">
            <h2>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
            <input type="text" id="username" placeholder="Ø§Ø³Ù…Ùƒ">
            <button onclick="saveName()">Ø¯Ø®ÙˆÙ„</button>
        </div>

        <div id="screen-menu" class="screen hidden">
            <h3 id="welcome-msg"></h3>
            <button onclick="createRoom()" style="background:#10b981; width:80%">Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ©</button>
            <br>
            <input type="text" id="code-input" placeholder="ÙƒÙˆØ¯ Ø§Ù„ØºØ±ÙØ©" style="width:100px">
            <button onclick="joinRoom()">Ø¯Ø®ÙˆÙ„</button>
        </div>

        <div id="screen-lobby" class="screen hidden">
            <h2>ØºØ±ÙØ©: <span id="lobby-code" style="color:var(--gold)"></span></h2>
            <ul id="lobby-list" style="list-style:none; padding:0; text-align:right"></ul>
            <button id="start-btn" class="hidden" onclick="startGame()">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¬ÙˆÙ„Ø©</button>
            <button onclick="leaveRoom()" style="background:var(--danger)">Ø®Ø±ÙˆØ¬</button>
        </div>

        <div id="screen-game" class="hidden" style="width:100%; height:100%">
            <div id="game-interface">
                <div style="padding:10px; display:flex; justify-content:space-between; align-items:center;">
                    <button onclick="leaveRoom()" style="background:var(--danger); font-size:12px; padding:5px 10px">Ø§Ù†Ø³Ø­Ø§Ø¨</button>
                    <span style="color:#aaa; font-size:12px">Room: <span id="game-code"></span></span>
                </div>

                <div id="table-surface">
                    <div id="opponents"></div> <div id="game-board"></div> </div>

                <div id="my-area">
                    <button id="draw-btn" class="hidden">Ø³Ø­Ø¨</button>
                    <div id="my-score-display" style="position:absolute; top:-25px; left:10px; color:var(--gold); font-weight:bold;">Ù†Ù‚Ø§ØªÙƒ: 0</div>
                    <div id="my-hand"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="chat-icon" class="hidden" onclick="toggleChat()">
        <div id="chat-badge" class="hidden">0</div>ğŸ’¬
    </div>
    <div id="chat-box" class="hidden">
        <div style="padding:5px; background:rgba(0,0,0,0.3); color:white; display:flex; justify-content:space-between;"><span>Chat</span><span onclick="toggleChat()" style="cursor:pointer">x</span></div>
        <div id="chat-msgs"></div>
        <div style="display:flex; padding:5px;"><input id="chat-in" style="flex:1; margin:0"><button onclick="sendMsg()" style="margin:0 5px">></button></div>
    </div>

<script>
    // --- Config ---
    const firebaseConfig = { apiKey: "AIzaSyCp9_P3K__Sr76iKgaVG1iD4NluUqPtni4", authDomain: "heka-codenames.firebaseapp.com", projectId: "heka-codenames", storageBucket: "heka-codenames.firebasestorage.app", messagingSenderId: "901713932504", appId: "1:901713932504:web:b6710ddf537cd3c7c4e7ad" };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // --- Variables ---
    let myName="", myId="", currentRoom="", isHost=false;
    let gameData={}, chatOpen=false, timerInt=null;
    let selectedTileIdx = -1; // Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„ÙˆØ±Ù‚Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© Ø¹Ù†Ø¯ Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±

    // --- Init ---
    window.onload = () => {
        if(localStorage.getItem('heka_pro_name')) {
            document.getElementById('username').value = localStorage.getItem('heka_pro_name');
            saveName();
        }
    };

    function show(id) {
        document.querySelectorAll('.screen, #screen-game').forEach(e => e.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
    }

    function saveName() {
        myName = document.getElementById('username').value.trim();
        if(!myName) return;
        localStorage.setItem('heka_pro_name', myName);
        document.getElementById('welcome-msg').innerText = `ÙŠØ§ Ù‡Ù„Ø§ Ø¨Ù€ ${myName}`;
        show('screen-menu');
    }

    // --- Room Logic ---
    function createRoom() {
        const code = Math.floor(1000+Math.random()*9000).toString();
        myId = Date.now().toString();
        db.ref('rooms/'+code).set({
            status: 'waiting', host: myId, roundCount: 0,
            players: { [myId]: { name: myName, score: 0, hand:[], count:0, isBot:false } }
        }).then(()=>enterRoom(code, true));
    }

    function joinRoom() {
        const code = document.getElementById('code-input').value.trim();
        if(!code) return;
        myId = Date.now().toString();
        db.ref('rooms/'+code).once('value', s => {
            if(!s.exists()) return alert("ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©");
            if(s.val().status !== 'waiting') return alert("Ø¨Ø¯Ø£Øª Ø¨Ø§Ù„ÙØ¹Ù„");
            if(Object.keys(s.val().players||{}).length >=4) return alert("Ù…Ù…ØªÙ„Ø¦Ø©");
            
            db.ref(`rooms/${code}/players/${myId}`).set({ name: myName, score: 0, hand:[], count:0, isBot:false })
            .then(()=>enterRoom(code, false));
        });
    }

    function enterRoom(code, host) {
        currentRoom = code; isHost = host;
        document.getElementById('lobby-code').innerText = code;
        document.getElementById('game-code').innerText = code;
        show('screen-lobby');
        if(isHost) document.getElementById('start-btn').classList.remove('hidden');
        document.getElementById('chat-icon').classList.remove('hidden');
        
        // Anti-Disconnect Logic: Ø¹Ù†Ø¯ Ø§Ù„Ø®Ø±ÙˆØ¬ØŒ ÙŠØªØ­ÙˆÙ„ Ù„Ø¨ÙˆØª
        db.ref(`rooms/${code}/players/${myId}`).onDisconnect().update({ isBot: true });
        
        listen();
    }

    function leaveRoom() {
        if(currentRoom && myId) db.ref(`rooms/${currentRoom}/players/${myId}`).update({ isBot: true }); // Mark as bot instead of delete
        location.reload();
    }

    function listen() {
        db.ref(`rooms/${currentRoom}`).on('value', s => {
            const d = s.val();
            if(!d) return location.reload();
            gameData = d;

            if(d.status === 'waiting') updateLobby(d.players);
            else if(d.status === 'playing') {
                if(document.getElementById('screen-game').classList.contains('hidden')) show('screen-game');
                updateGame(d);
                checkTimer(d);
            } 
            else if (d.status === 'finished') {
                // Ø¹Ø±Ø¶ Ø§Ù„ÙØ§Ø¦Ø²
                alert(`Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø¬ÙˆÙ„Ø©! Ø§Ù„ÙØ§Ø¦Ø²: ${d.roundWinnerName}`);
                if(isHost) setTimeout(startGame, 3000); // Ø¨Ø¯Ø¡ Ø¬ÙˆÙ„Ø© Ø¬Ø¯ÙŠØ¯Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
            }
            else if (d.status === 'match_over') {
                document.getElementById('winner-name').innerText = d.matchWinnerName;
                document.getElementById('screen-winner').classList.remove('hidden');
            }

            updateChat(d.chat);
        });
    }

    function updateLobby(players) {
        const list = document.getElementById('lobby-list');
        list.innerHTML = "";
        Object.values(players||{}).forEach(p => list.innerHTML += `<li>${p.name} ${p.isBot?'ğŸ¤–':''} - ğŸ†${p.score}</li>`);
    }

    // --- Game Logic ---
    function startGame() {
        const pIds = Object.keys(gameData.players);
        if(pIds.length < 2) return alert("ÙŠØ¬Ø¨ ØªÙˆÙØ± Ù„Ø§Ø¹Ø¨ÙŠÙ†");
        pIds.sort(); // ØªØ±ØªÙŠØ¨ Ø«Ø§Ø¨Øª

        // ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø¯ÙˆÙ…ÙŠÙ†Ùˆ
        let tiles = [];
        for(let i=0; i<=6; i++) for(let j=i; j<=6; j++) tiles.push({a:i, b:j});
        
        let handSize = 7;
        if(pIds.length === 3) {
            tiles = tiles.filter(t => !(t.a===0 && t.b===0));
            handSize = 9;
        }

        // Ø®Ù„Ø·
        tiles.sort(()=>Math.random()-0.5);

        const updates = { status: 'playing', board: [], stock: tiles, playerOrder: pIds };
        
        // ØªÙˆØ²ÙŠØ¹
        let startTurnIndex = 0;
        let hasSixSix = -1;

        pIds.forEach((id, idx) => {
            const hand = tiles.splice(0, handSize);
            updates[`players/${id}/hand`] = hand;
            updates[`players/${id}/count`] = handSize;
            
            // ÙØ­Øµ 6-6 Ù„Ù„Ø¬ÙˆÙ„Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰
            if(gameData.roundCount === 0) {
                if(hand.some(t => t.a===6 && t.b===6)) hasSixSix = idx;
            }
        });

        // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¯ÙˆØ±
        if(gameData.roundCount === 0) {
            // Ø§Ù„Ø¬ÙˆÙ„Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰: Ù…Ù† Ù…Ø¹Ù‡ 6-6
            startTurnIndex = (hasSixSix !== -1) ? hasSixSix : 0;
        } else {
            // Ø§Ù„Ø¬ÙˆÙ„Ø§Øª Ø§Ù„ØªØ§Ù„ÙŠØ©: Ø§Ù„ÙØ§Ø¦Ø² Ø§Ù„Ø³Ø§Ø¨Ù‚
            if(gameData.lastWinnerId) {
                const idx = pIds.indexOf(gameData.lastWinnerId);
                startTurnIndex = (idx !== -1) ? idx : 0;
            }
        }

        updates['turnIndex'] = startTurnIndex;
        updates['turnStartTime'] = firebase.database.ServerValue.TIMESTAMP;
        updates['roundCount'] = (gameData.roundCount || 0) + 1;

        db.ref('rooms/'+currentRoom).update(updates);
    }

    function updateGame(data) {
        const pIds = data.playerOrder;
        const myIdx = pIds.indexOf(myId);
        const turnId = pIds[data.turnIndex];
        
        // Ø±Ø³Ù… Ø§Ù„Ø®ØµÙˆÙ…
        const oppDiv = document.getElementById('opponents');
        oppDiv.innerHTML = "";
        const count = pIds.length;

        for(let i=1; i<count; i++) {
            const tIdx = (myIdx + i) % count;
            const tId = pIds[tIdx];
            const p = data.players[tId];
            
            let cls = "pos-top";
            if(count===3) cls = (i===1) ? "pos-right" : "pos-left";
            if(count===4) cls = (i===1) ? "pos-right" : (i===2 ? "pos-top" : "pos-left");

            const isTurn = (turnId === tId);
            oppDiv.innerHTML += `
                <div class="player-pos ${cls} ${isTurn?'active-turn':''}">
                    <div style="font-size:20px">ğŸ‘¤</div>
                    <div>${p.name} ${p.isBot?'ğŸ¤–':''}</div>
                    <div style="color:#aaa">${p.count} ğŸ€„</div>
                    <div class="p-score">${p.score} pts</div>
                    ${isTurn ? '<div class="timer-bar" id="tbar-'+tId+'"></div>' : ''}
                </div>
            `;
        }

        // Ù…Ù†Ø·Ù‚ØªÙŠ
        document.getElementById('my-score-display').innerText = `Ù†Ù‚Ø§Ø·Ùƒ: ${data.players[myId].score}`;
        const myArea = document.getElementById('my-area');
        if(turnId === myId) {
            myArea.style.borderTop = "3px solid var(--gold)";
            if(!document.getElementById('my-timer')) myArea.insertAdjacentHTML('afterbegin', `<div id="my-timer" class="timer-bar" style="position:absolute; top:0; width:100%"></div>`);
        } else {
            myArea.style.borderTop = "1px solid #444";
            if(document.getElementById('my-timer')) document.getElementById('my-timer').remove();
        }

        // Ø±Ø³Ù… Ø§Ù„Ø·Ø§ÙˆÙ„Ø©
        renderBoard(data.board||[]);
        // Ø±Ø³Ù… ÙŠØ¯ÙŠ
        renderHand(data.players[myId].hand||[]);

        // Ø²Ø± Ø§Ù„Ø³Ø­Ø¨ (ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· ÙÙŠ Ø§Ù„Ø«Ù†Ø§Ø¦ÙŠ ÙˆØ¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©)
        const btn = document.getElementById('draw-btn');
        btn.classList.add('hidden');
        if(turnId === myId && count === 2 && !hasMove(data.players[myId].hand, data.board)) {
            if(data.stock && data.stock.length > 0) {
                btn.classList.remove('hidden');
                btn.onclick = drawTile;
            }
        }
    }

    // --- Core Gameplay ---
    function playTileCheck(idx) {
        const pIds = gameData.playerOrder;
        if(pIds[gameData.turnIndex] !== myId) return;

        const hand = gameData.players[myId].hand;
        const tile = hand[idx];
        const board = gameData.board || [];

        if(board.length === 0) {
            // Ø£ÙˆÙ„ ÙˆØ±Ù‚Ø© ÙÙŠ Ø§Ù„Ø¬ÙˆÙ„Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 6-6
            if(gameData.roundCount === 1) {
               // Ø¥Ø°Ø§ ÙƒÙ†Øª Ø£Ù†Ø§ ØµØ§Ø­Ø¨ Ø§Ù„Ù€ 6-6 ÙŠØ¬Ø¨ Ø£Ù† Ø£Ù„Ø¹Ø¨Ù‡Ø§
               // Ø§Ù„ÙƒÙˆØ¯ Ø¨Ø³ÙŠØ·: Ù†Ø³Ù…Ø­ Ø¨Ø£ÙŠ ÙˆØ±Ù‚Ø© Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† 6-6 Ù…ÙˆØ¬ÙˆØ¯Ø© (Ø§Ø­ØªÙŠØ§Ø·)
               // Ù„ÙƒÙ† "startGame" Ø¶Ø¨Ø· Ø§Ù„Ø¯ÙˆØ± Ø¹Ù„Ù‰ Ù…Ù† Ù…Ø¹Ù‡ 6-6.
               // Ù‡Ù†Ø§ ØªØ­Ù‚Ù‚: Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø¹ÙŠ 6-6ØŒ ÙŠØ¬Ø¨ Ø£Ù† Ø£Ù„Ø¹Ø¨Ù‡Ø§ Ù‡ÙŠ ÙÙ‚Ø·.
               const has66 = hand.findIndex(t => t.a===6 && t.b===6);
               if(has66 !== -1 && (tile.a!==6 || tile.b!==6)) return alert("Ù„Ø§Ø²Ù… ØªÙ„Ø¹Ø¨ Ø§Ù„Ù€ 6-6 Ø§Ù„Ø£ÙˆÙ„!");
            }
            commitMove(idx, 'any');
            return;
        }

        const l = board[0].a;
        const r = board[board.length-1].b;
        const canLeft = (tile.a === l || tile.b === l);
        const canRight = (tile.a === r || tile.b === r);

        if (canLeft && canRight && l !== r) {
            // Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø§ØµØ©: Ø§Ù„ÙˆØ±Ù‚Ø© ØªØ±ÙƒØ¨ ÙÙŠ Ø§Ù„Ø¬Ù‡ØªÙŠÙ† ÙˆØ§Ù„Ø·Ø§ÙˆÙ„Ø© Ù„ÙŠØ³Øª Ù…Ù‚ÙÙ„Ø© Ø¨Ù†ÙØ³ Ø§Ù„Ø±Ù‚Ù…
            selectedTileIdx = idx;
            document.getElementById('choice-modal').classList.remove('hidden');
        } else if (canLeft) {
            commitMove(idx, 'left');
        } else if (canRight) {
            commitMove(idx, 'right');
        } else {
            alert("Ø§Ù„ÙˆØ±Ù‚Ø© Ù„Ø§ ØªÙ†Ø§Ø³Ø¨ Ø§Ù„Ø·Ø§ÙˆÙ„Ø©");
        }
    }

    function resolveChoice(side) {
        document.getElementById('choice-modal').classList.add('hidden');
        commitMove(selectedTileIdx, side);
    }

    function commitMove(idx, side) {
        const hand = gameData.players[myId].hand;
        const tile = hand[idx];
        let board = [...(gameData.board || [])];
        let newTile = {...tile};

        if(side === 'any' || board.length === 0) {
            board.push(newTile);
        } else if (side === 'left') {
            const end = board[0].a;
            if(newTile.a === end) { newTile = {a:tile.b, b:tile.a}; } // flip
            board.unshift(newTile);
        } else { // right
            const end = board[board.length-1].b;
            if(newTile.b === end) { newTile = {a:tile.b, b:tile.a}; } // flip
            board.push(newTile);
        }

        hand.splice(idx, 1);
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙÙˆØ²
        if(hand.length === 0) {
            handleRoundWin(myId, board);
        } else {
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† "Ø§Ù„Ù‚ÙÙ„Ø©" (Blocked)
            if(isGameBlocked(board, gameData.players)) {
                handleBlockedGame(board);
            } else {
                nextTurn(board, hand);
            }
        }
    }

    function nextTurn(board, hand) {
        const pIds = gameData.playerOrder;
        const next = (gameData.turnIndex + 1) % pIds.length;
        db.ref('rooms/'+currentRoom).update({
            board: board,
            turnIndex: next,
            turnStartTime: firebase.database.ServerValue.TIMESTAMP,
            [`players/${myId}/hand`]: hand,
            [`players/${myId}/count`]: hand.length
        });
    }

    // --- Scoring Logic ---
    function handleRoundWin(winnerId, board) {
        let totalPips = 0;
        const players = gameData.players;
        Object.keys(players).forEach(id => {
            if(id !== winnerId) {
                players[id].hand.forEach(t => totalPips += (t.a + t.b));
            }
        });

        const newScore = (players[winnerId].score || 0) + totalPips;
        
        const updates = {
            [`players/${winnerId}/score`]: newScore,
            status: 'finished',
            lastWinnerId: winnerId,
            roundWinnerName: players[winnerId].name,
            board: board, // Update final board view
            [`players/${winnerId}/hand`]: []
        };

        if(newScore >= 101) {
            updates.status = 'match_over';
            updates.matchWinnerName = players[winnerId].name;
        }

        db.ref('rooms/'+currentRoom).update(updates);
    }

    function isGameBlocked(board, players) {
        // ÙØ­Øµ Ù…Ø¨Ø³Ø·: Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù„Ø¯Ù‰ Ø£ÙŠ Ù„Ø§Ø¹Ø¨ ÙˆØ±Ù‚Ø© ØªÙ†Ø§Ø³Ø¨ Ø§Ù„Ø£Ø·Ø±Ø§Ù ÙˆÙ„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø­Ø¨
        // Ù‡Ø°Ø§ ÙŠØ­ØªØ§Ø¬ Ù„Ù…Ù†Ø·Ù‚ Ù…Ø¹Ù‚Ø¯ØŒ Ù„ÙƒÙ† Ø³Ù†Ø¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ "Ø²Ø± Ø§Ù„Ø¨Ø§Ø³" Ø£Ùˆ Ø§Ù„Ù…Ø¤Ù‚Øª Ù„Ù„Ø¨ÙˆØª
        // Ù‡Ù†Ø§ Ø³Ù†ÙØªØ±Ø¶ Ø£Ù† Ø§Ù„Ù„Ø¹Ø¨Ø© ØªØºÙ„Ù‚ Ø¥Ø°Ø§ Ù…Ø± Ø¯ÙˆØ± ÙƒØ§Ù…Ù„ Ø¯ÙˆÙ† Ù„Ø¹Ø¨ (ÙÙŠ Ø§Ù„ÙˆØ§Ù‚Ø¹ ÙŠØªÙ… Ø­Ø³Ø§Ø¨Ù‡Ø§ Ø¨Ø§Ù„ÙˆØ±Ù‚ Ø§Ù„Ù…ÙŠØª)
        // Ù„Ù„ØªØ¨Ø³ÙŠØ· ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯: Ø³Ù†Ø¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø£Ù† Ø§Ù„Ø¨ÙˆØª Ø³ÙŠÙ…Ø±Ø± Ø§Ù„Ø¯ÙˆØ±ØŒ ÙˆØ¥Ø°Ø§ Ù…Ø±Ø± Ø§Ù„Ø¬Ù…ÙŠØ¹ ØªÙ†ØªÙ‡ÙŠ.
        // *ØªØ¹Ø¯ÙŠÙ„*: Ø³Ù†Ù†ÙØ° Ø§Ù„Ù‚ÙÙ„Ø© Ø¹Ù†Ø¯Ù…Ø§ ÙŠØµØ¨Ø­ Ø§Ù„Ù€ Stock ÙØ§Ø±ØºØ§Ù‹ ÙˆÙ„Ø§ Ø£Ø­Ø¯ ÙŠÙ…Ù„Ùƒ Ø­Ø±ÙƒØ©.
        return false; // Ø³Ù†ØªØ±ÙƒÙ‡Ø§ Ù„Ù„Ù…Ø¤Ù‚Øª Ù„ÙŠÙ†Ù‡ÙŠ Ø§Ù„Ù„Ø¹Ø¨Ø© Ø¥Ø°Ø§ Ù„Ù… ÙŠÙ„Ø¹Ø¨ Ø£Ø­Ø¯
    }
    
    // Ø¯Ø§Ù„Ø© Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ù‚ÙÙ„Ø© Ø¹Ù†Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ÙˆÙ‚Øª ÙˆØ§Ù„Ø®ÙŠØ§Ø±Ø§Øª (ØªØ³ØªØ¯Ø¹Ù‰ Ù…Ù† Ø§Ù„Ø¨ÙˆØª)
    function handleBlockedGame(board) {
        // Ø­Ø³Ø§Ø¨ Ù…Ù† Ø§Ù„Ø£Ù‚Ù„ Ù†Ù‚Ø§Ø·Ø§Ù‹
        let minPips = 1000;
        let winnerId = "";
        let totalLosersPips = 0;
        
        Object.entries(gameData.players).forEach(([id, p]) => {
            let pips = 0;
            (p.hand||[]).forEach(t => pips += t.a+t.b);
            if(pips < minPips) { minPips = pips; winnerId = id; }
            totalLosersPips += pips; // Ù†Ø¬Ù…Ø¹ Ø§Ù„ÙƒÙ„
        });

        // Ø§Ù„ÙØ§Ø¦Ø² ÙŠØ£Ø®Ø° Ù†Ù‚Ø§Ø· Ø§Ù„Ø¬Ù…ÙŠØ¹ (Ø£Ùˆ Ù†Ù‚Ø§Ø· Ø§Ù„Ø®Ø§Ø³Ø±ÙŠÙ† ÙÙ‚Ø· Ø­Ø³Ø¨ Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø©ØŒ Ù‡Ù†Ø§ Ø³Ù†Ø¹Ø·ÙŠÙ‡ Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø®Ø§Ø³Ø±ÙŠÙ† - Ù†Ù‚Ø§Ø·Ù‡ Ù‡Ùˆ)
        totalLosersPips -= minPips; 
        
        const newScore = (gameData.players[winnerId].score || 0) + totalLosersPips;
        
        const updates = {
            [`players/${winnerId}/score`]: newScore,
            status: 'finished',
            lastWinnerId: winnerId,
            roundWinnerName: gameData.players[winnerId].name + " (Ø¨Ø§Ù„Ù†Ù‚Ø§Ø·)",
        };
        if(newScore >= 101) {
             updates.status = 'match_over';
             updates.matchWinnerName = gameData.players[winnerId].name;
        }
        db.ref('rooms/'+currentRoom).update(updates);
    }

    function drawTile() {
        let stock = gameData.stock || [];
        if(stock.length === 0) return; // Pass turn logic handled by timer usually
        
        const tile = stock.pop();
        const hand = gameData.players[myId].hand;
        hand.push(tile);
        
        db.ref('rooms/'+currentRoom).update({
            stock: stock,
            [`players/${myId}/hand`]: hand,
            [`players/${myId}/count`]: hand.length
        });
    }

    // --- Helpers ---
    function hasMove(hand, board) {
        if(!board || board.length===0) return true;
        const l = board[0].a, r = board[board.length-1].b;
        return hand.some(t => t.a===l || t.b===l || t.a===r || t.b===r);
    }

    function checkTimer(data) {
        if(timerInt) clearInterval(timerInt);
        const startTime = data.turnStartTime || Date.now();
        const turnId = data.playerOrder[data.turnIndex];
        
        timerInt = setInterval(() => {
            const elapsed = (Date.now() - startTime) / 1000;
            const remaining = 40 - elapsed;
            
            // ØªØ­Ø¯ÙŠØ« Ø´Ø±ÙŠØ· Ø§Ù„ÙˆÙ‚Øª
            const bar = document.getElementById(turnId===myId ? 'my-timer' : 'tbar-'+turnId);
            if(bar) bar.style.width = Math.max(0, (remaining/40)*100) + "%";

            if(remaining <= 0) {
                clearInterval(timerInt);
                // Ø¥Ø°Ø§ ÙƒÙ†Øª Ø£Ù†Ø§ ØµØ§Ø­Ø¨ Ø§Ù„Ø¯ÙˆØ± ÙˆØ§Ù†ØªÙ‡Ù‰ ÙˆÙ‚ØªÙŠ -> Ø§Ù„Ø¨ÙˆØª ÙŠÙ„Ø¹Ø¨
                if(turnId === myId) autoBot(myId);
                // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¯ÙˆØ± Ù„Ø¨ÙˆØª Ø£Ùˆ Ù„Ø§Ø¹Ø¨ Ù…ÙØµÙˆÙ„ØŒ ÙˆØ§Ù„Ù‡ÙˆØ³Øª Ù…ÙˆØ¬ÙˆØ¯ -> Ø§Ù„Ù‡ÙˆØ³Øª ÙŠÙ„Ø¹Ø¨ Ù„Ù‡
                else if(isHost && (data.players[turnId].isBot)) autoBot(turnId);
            }
        }, 1000);
    }

    function autoBot(playerId) {
        // Ù…Ù†Ø·Ù‚ Ø§Ù„Ù„Ø¹Ø¨ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
        const p = gameData.players[playerId];
        const hand = p.hand || [];
        const board = gameData.board || [];
        
        // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥ÙŠØ¬Ø§Ø¯ ÙˆØ±Ù‚Ø©
        let played = false;
        let playIdx = -1;
        let side = 'right';

        if(board.length === 0) {
            playIdx = 0; 
            side = 'any';
        } else {
            const l = board[0].a, r = board[board.length-1].b;
            for(let i=0; i<hand.length; i++) {
                if(hand[i].a===r || hand[i].b===r) { playIdx=i; side='right'; break; }
                if(hand[i].a===l || hand[i].b===l) { playIdx=i; side='left'; break; }
            }
        }

        if(playIdx !== -1) {
            // ØªÙ†ÙÙŠØ° Ø§Ù„Ø­Ø±ÙƒØ© (ÙŠØ¬Ø¨ ØªÙƒØ±Ø§Ø± ÙƒÙˆØ¯ commitMove Ù‡Ù†Ø§ Ù„ÙƒÙ† Ø¨ØµÙŠØºØ© ØªØ­Ø¯ÙŠØ« Ù…Ø¨Ø§Ø´Ø± Ù„Ù„Ù‚Ø§Ø¹Ø¯Ø© Ù„Ø£Ù† Ø§Ù„Ø¨ÙˆØª Ù„Ø§ ÙŠØ³ØªØ®Ø¯Ù… Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©)
            // Ù„Ù„ØªØ¨Ø³ÙŠØ·: Ø¥Ø°Ø§ ÙƒØ§Ù† Ø£Ù†Ø§ØŒ Ø£Ø³ØªØ¯Ø¹ÙŠ playTileCheckØŒ Ø¥Ø°Ø§ Ù‡ÙˆØ³Øª Ù„Ø¨ÙˆØªØŒ Ø£Ø­Ø¯Ø« Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø©
            if(playerId === myId) {
                commitMove(playIdx, side); // Ø­ØªÙ‰ Ù„Ùˆ Ø§Ø®ØªØ±Ù†Ø§ Ø£ÙŠ Ø¬Ø§Ù†Ø¨
            } else {
                // Host executing bot move
                // Ù†Ø­ØªØ§Ø¬ ÙƒÙˆØ¯ Ù…Ø´Ø§Ø¨Ù‡ Ù„Ù€ commitMove ÙŠØ¹Ù…Ù„ Ù…Ø¨Ø§Ø´Ø±Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø¯Ø§ØªØ§
                const tile = hand[playIdx];
                let newTile = {...tile};
                let newBoard = [...board];
                
                if(side === 'left') {
                   if(newTile.a === board[0].a) newTile = {a:tile.b, b:tile.a};
                   newBoard.unshift(newTile);
                } else {
                   const end = board.length ? board[board.length-1].b : -1;
                   if(board.length && newTile.b === end) newTile = {a:tile.b, b:tile.a};
                   newBoard.push(newTile);
                }
                
                hand.splice(playIdx, 1);
                const next = (gameData.turnIndex + 1) % gameData.playerOrder.length;
                
                const updates = {
                   board: newBoard, turnIndex: next, turnStartTime: firebase.database.ServerValue.TIMESTAMP,
                   [`players/${playerId}/hand`]: hand, [`players/${playerId}/count`]: hand.length
                };
                
                if(hand.length === 0) {
                     // Bot Wins
                     // Ù†Ø­ØªØ§Ø¬ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†Ù‚Ø§Ø· Ù‡Ù†Ø§ Ø£ÙŠØ¶Ø§Ù‹... (Ù…ÙƒØ±Ø±)
                     // Ù„Ù„ØªØ¨Ø³ÙŠØ·: Ù†Ù†Ù‡ÙŠ Ø§Ù„Ø¬ÙˆÙ„Ø© ÙÙ‚Ø·
                     updates.status = 'finished';
                     updates.roundWinnerName = p.name;
                     updates.lastWinnerId = playerId;
                     // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù†Ù‚Ø§Ø· Ù„Ù„Ø¨ÙˆØª (Ù…Ù‡Ù…Ø© Ø§Ù„Ù‡ÙˆØ³Øª)
                     let total = 0;
                     Object.keys(gameData.players).forEach(oid => {
                         if(oid!==playerId) gameData.players[oid].hand.forEach(t=> total+=t.a+t.b);
                     });
                     updates[`players/${playerId}/score`] = (p.score||0)+total;
                }
                
                db.ref('rooms/'+currentRoom).update(updates);
            }
        } else {
            // Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØ±Ù‚Ø©
            if(gameData.playerOrder.length === 2 && (gameData.stock||[]).length > 0) {
                 // Ø³Ø­Ø¨
                 const stock = gameData.stock;
                 const t = stock.pop();
                 hand.push(t);
                 db.ref('rooms/'+currentRoom).update({
                     stock: stock,
                     [`players/${playerId}/hand`]: hand,
                     [`players/${playerId}/count`]: hand.length
                 });
            } else {
                // Pass
                const next = (gameData.turnIndex + 1) % gameData.playerOrder.length;
                db.ref('rooms/'+currentRoom).update({
                    turnIndex: next, turnStartTime: firebase.database.ServerValue.TIMESTAMP
                });
            }
        }
    }

    // --- Rendering Utils ---
    function renderHand(hand) {
        const d = document.getElementById('my-hand'); d.innerHTML = "";
        hand.forEach((t, i) => d.innerHTML += createDomino(t, 'hand-tile', `onclick="playTileCheck(${i})"`) );
    }
    function renderBoard(board) {
        const d = document.getElementById('game-board'); d.innerHTML = "";
        board.forEach(t => d.innerHTML += createDomino(t, (t.a===t.b ? 'board-tile double' : 'board-tile'), '') );
    }
    function createDomino(t, cls, attr) {
        return `<div class="domino ${cls}" ${attr}>
            <div class="pip-container">${getPips(t.a)}</div><div class="line"></div><div class="pip-container">${getPips(t.b)}</div>
        </div>`;
    }
    function getPips(n) {
        const m={1:['p1'],2:['p2-1','p2-2'],3:['p3-1','p3-2','p3-3'],4:['p4-1','p4-2','p4-3','p4-4'],5:['p5-1','p5-2','p5-3','p5-4','p5-5'],6:['p6-1','p6-2','p6-3','p6-4','p6-5','p6-6']};
        return (m[n]||[]).map(c=>`<div class="pip ${c}"></div>`).join('');
    }

    // --- Chat ---
    function toggleChat(){ chatOpen=!chatOpen; document.getElementById('chat-box').classList.toggle('hidden'); document.getElementById('chat-badge').classList.add('hidden'); }
    function sendMsg(){ const i=document.getElementById('chat-in'); if(i.value) db.ref(`rooms/${currentRoom}/chat`).push({n:myName, t:i.value}); i.value=""; }
    function updateChat(c){ 
        const b=document.getElementById('chat-msgs'); b.innerHTML=Object.values(c||{}).map(m=>`<div class="msg ${m.n===myName?'mine':''}"><b>${m.n}:</b> ${m.t}</div>`).join(''); 
        if(!chatOpen && c) document.getElementById('chat-badge').classList.remove('hidden');
    }
</script>
</body>
</html>
